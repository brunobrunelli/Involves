create database db_involves;
use db_involves;

begin;

---------------------------------------------------------------------------------------------------

create table PONTO_VENDA_UNIDADE (
	ID INT PRIMARY KEY,
    ANO INT,
    MES INT,
    PERFIL_PDV VARCHAR(255),
    TIPO_PDV VARCHAR(255),
    ID_PDV INT,
    NOME_PDV VARCHAR(255),
    SELLIN DOUBLE
);

INSERT INTO PONTO_VENDA_UNIDADE VALUES (1,2020,10,'P','ATACADO',1,'Involves',20000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (2,2020,10,'M','VAREJO',2,'Stage',120000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (3,2020,10,'G','VAREJO',3,'Zero',5000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (4,2020,10,'P','ATACADO',4,'Studio',23000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (5,2020,10,'M','VAREJO',5,'RecImagem',19000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (6,2020,10,'G','VAREJO',6,'Agile',24000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (7,2020,11,'P','ATACADO',1,'Involves',10000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (8,2020,11,'M','VAREJO',2,'Stage',210000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (9,2020,11,'G','VAREJO',3,'Zero',25000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (10,2020,11,'P','ATACADO',4,'Studio',17000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (11,2020,11,'M','VAREJO',5,'RecImagem',20000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (12,2020,11,'G','VAREJO',6,'Agile',24000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (13,2020,12,'P','ATACADO',1,'Involves',210000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (14,2020,12,'M','VAREJO',2,'Stage',5000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (15,2020,12,'G','VAREJO',3,'Zero',23000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (16,2020,12,'P','ATACADO',4,'Studio',19000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (17,2020,12,'M','VAREJO',5,'RecImagem',24000);
INSERT INTO PONTO_VENDA_UNIDADE VALUES (18,2020,12,'G','VAREJO',6,'Agile',45000);

---------------------------------------------------------------------------------------------------

create table VISITAS_PONTO_VENDA (
	ID INT PRIMARY KEY,
    ANO INT,
    MES INT,
    FK_PDV INT,
    FL_VISITADO INT
);

INSERT INTO VISITAS_PONTO_VENDA VALUES (1,2020,10,1,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (2,2020,10,2,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (3,2020,10,3,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (4,2020,10,4,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (5,2020,10,5,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (6,2020,10,6,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (7,2020,11,1,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (8,2020,11,2,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (9,2020,11,3,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (10,2020,11,4,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (11,2020,11,5,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (12,2020,11,6,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (13,2020,12,1,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (14,2020,12,2,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (15,2020,12,3,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (16,2020,12,4,1);
INSERT INTO VISITAS_PONTO_VENDA VALUES (17,2020,12,5,0);
INSERT INTO VISITAS_PONTO_VENDA VALUES (18,2020,12,6,0);

---------------------------------------------------------------------------------------------------

select * from PONTO_VENDA_UNIDADE;

select * from VISITAS_PONTO_VENDA;

-- EXERCÍCIO - 2:
SELECT * 
FROM PONTO_VENDA_UNIDADE
WHERE SELLIN > 20000
ORDER BY NOME_PDV;

-- EXERCÍCIO - 3:
SELECT NOME_PDV, ANO, MES, SUM(SELLIN) AS AGG_PDV
FROM PONTO_VENDA_UNIDADE
GROUP BY NOME_PDV, ANO, MES
ORDER BY MES ASC, NOME_PDV;

-- EXERCÍCIO - 4:
SELECT NOME_PDV, SUM(VPV.FL_VISITADO) 
FROM PONTO_VENDA_UNIDADE PVU
LEFT JOIN VISITAS_PONTO_VENDA VPV ON (PVU.ID_PDV = VPV.FK_PDV)
WHERE NOME_PDV = 'Involves';


select
	FT.CICLO,
	FT.ID_DIM_PDV,
	FT.ID_BLOCO_ITEM,
	SUM(FT.QTD_PONTO_EXTRA),
	SUM(FTPI.TOTAL_NOTA_ITEM)
from FT_DOMINANCIA_PONTO_EXTRA_COMPLIANCE FT
inner join TABREF_PAINEL_LOJAS_LP TPLL on FT.ID_DIM_PDV = TPLL.ID_DIM_PDV and FT.CICLO = TPLL.CICLO
inner join FT_PERFECTSTORE_ITEM FTPI on FT.CICLO = FTPI.CICLO
	and FT.ID_DIM_PDV = FTPI.ID_DIM_PDV
	and FT.ID_BLOCO_ITEM = FTPI.ID_BLOCO_ITEM
	and FT.SEMANA_LP = FTPI.SEMANA_LP
where FT.CICLO = 202009
and FT.ID_DIM_PDV = 223459792
group by FT.CICLO, FT.ID_DIM_PDV;

CREATE INDEX IX_CICLO ON FT_DOMINANCIA_PONTO_EXTRA_COMPLIANCE (CICLO);
